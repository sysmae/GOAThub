> ❗ **이 문서 Youtube API접속불가능한 Trouble shooting 전과정을 담은 문서입니다.**
> 

# 1]개요

## 1. 문제 정의

- **EC2 Streamlit 애플리케이션 컨테이너 환경에서 YouTube API 요청 시 지속적인 `CONNECT: 54`, `TAG_NONE/000`, `timeout` 오류 발생**

## 2. 원인

- YouTube는 AWS와 같은 클라우드 대역에서 오는 반복적인 HTTPS 요청을 봇으로 간주하고 차단하거나 제한

## 3. 목적

- YouTube API 요청을 우회할 수 있는 안정적인 네트워크 경로 구성

---

# 2] 문제 해결 과정 - 1단계 
     (EC2 → 로컬PC로 직접 포워드 프록시 구성 시도)

### 1. 개요

- EC2가 직접 로컬 PC의 Squid 서버를 통해 외부로 요청하는 구조

### 2. 구성

```

[EC2 서버에서 실행 중인 Streamlit 앱]
   ↓ (Youtube 요청 발생)
[프록시 옵션으로 요청 전송: -x http://<로컬IP>:3128]
   ↓
[Windows 공인IP:3128에서 수신]
   ↓ (netsh portproxy)
[WSL2 내부 IP:3128 (Docker로 구동된 Squid에게 전달)]
   ↓
[Squid가 요청 처리 후 외부로 보냄]
   ↓
[통신은 결국 Windows의 NIC를 통해 인터넷으로 나감]
```

### 3. 주요설정

- 로컬 PC Windows 방화벽 예외 규칙 추가
- EC2 인바운드규칙 방화벽 예외 규칙 추가
- WSL2 Squid 서버 구성
- netsh portproxy로 포트 전달 구성

### ❌ **결과: 실패 (CONNECT: 54 오류)**

### 4. 실패 원인

- **공유기 NAT/포트포워딩 미설정**
    - EC2는 외부 공인 IP를 통해 요청을 보냄. 그러나 로컬 PC는 일반적으로 공유기 아래에 있는 사설 IP임. 공유기에서 3128 포트를 로컬 PC로 포워딩하지 않으면 외부에서 접근 불가
- **ISP 혹은 캠퍼스망의 외부 인입 제한**
    - 가정/학교/회사 등의 네트워크는 포트 3128 등 비표준 포트의 외부 접근을 차단하는 경우가 많음. 이 경우 공유기 포트포워딩을 해도 외부에서 접근 불가
- **WSL2의 네트워크 특성**
    - WSL2는 내부적으로 가상 NIC를 사용하며, WSL 내부 포트가 직접 외부에서 접근되지 않음. Windows 자체가 수신한 포트를 `netsh portproxy`로 WSL로 넘겨야 함

---

# 2] 문제 해결 과정 - 2단계 
     (역방향 SSH 터널링을 통한 프록시 구성)

### 1. 개요

- 기존 프록시를통한 방법은 공유기, 방화벽, WSL 등 통신을 저해하는 요소들이 많아 
로컬PC가 먼저 EC2내부로 SSH 터널을 역방향으로 구성해 EC2가 트래픽을 보내는 구조를 설계
- EC2 내부에 가짜 입구(1080)을 만들어 셰션을 연결해주는 방식
(EC2입장에서는 자기자신에게 요청을 보내는듯하지만 실제로는 SSH터널을 통해 로컬PC로 요청전달)

 

### 2. 구성

```
[EC2 서버에서 실행 중인 Streamlit 앱]
    ↓ (HTTP_PROXY 설정 → localhost:1080)
    ↓ 
[EC2 내부 포트 1080 ← SSH 역방향 포워딩]
    ↓
[Windows 공인IP:8888에서 수신]
   ↓ (netsh portproxy 로 8888에서 squid 프록시 3128로 포워딩)
   ↓ 
[로컬 PC의 포트 3128 (WSL2 내부 squid 프록시)]
    ↓ (Squid가 요청 처리 후 외부로 보냄)
    ↓ 
[인터넷 (YouTube, httpbin.org)]
```

### 3. 주요 설정 맟 해결된 사안

- **Windows 방화벽의 외부 포트 차단 해결**
    - EC2가 직접 3128로 접속하지 않고, SSH 연결된 세션을 통해 역방향으로 트래픽을 밀어넣음. 즉, 외부에서 진입되는 게 아니라 내부로부터 연결됨
- **WSL2 직접 접근 불가 해결**
    - SSH 터널의 끝단을 Windows localhost:8888로 두고 windows에서 ssh터널로부터의 요청을 해당 포트로 수신해 이를 netsh portproxy로 WSL2 3128로 포워딩해 squid 프록시서버로 중계
- **클라우드에서 민감 API 접근 차단 해결**
    - 기존 EC2 클라우드 네트워크환경에서 요청을보내는게 아닌 로컬PC 네트워크환경에서 요청을 보내게 되므로 해당 문제는 해결

### ❌ 결과: 실패 (timeout, TAG_NONE/000 오류)

### 4. 실패 원인

- 로컬 공유기, 네트워크 보안 장비가 SSH 터널 내부 트래픽을 차단
    - SSH 터널은 살아있지만, 내부 트래픽이 전달되지 않음
- 가정/학교망 제한 가능성
    - ISP 또는 방화벽단에서 SSH트래픽자체가 throttle되거나 거부될 가능
- 복잡한 구성으로 인해 어느 한 부분에서 설정이 어긋난 경

---

# 3] 문제 해결 과정 - 3단계 
     (Webshare Residential Proxy 도입)

### 1. 개요

- 유료 residential 프록시 서비스(Webshare.io) 사용
- https인증 포함된 프록시 URL로 직접 요청

### 2. 구성

```
[EC2 Streamlit 컨테이너]
   ↓ HTTPS_PROXY=http://user:pass@p.webshare.io:80
   ↓
[Webshare Residential Proxy]
   ↓
   ↓
[YouTube API 서버]
```

### 3. 주요 설정

- main코드수준에서 프록시경유하도록 하드코딩
    - 문서 및 메인코드 참조

### 4. 해결된 요소

- **라우터/공유기 포트 제한, 트래픽 필터링**
    - 외부의 인증된 프록시 서버를 사용하므로 ISP·방화벽 영향 없음
- **복잡한 포트포워딩(netsh, WSL2, NAT 등)**
    - 단일 프록시주소를 경유하므로 네트워크구성이 간단해져 네트워크구성에서 작업자의 실수를 줄임
- **WSL IP 변경 대응 필요없어짐**
    - 프록시는 외부 네트워크 상의 고정 IP
- **SSH 셰션 유지 및 로컬PC 가동의 한계 극복**
    - 서비스 이용을 위해서는 로컬PC가 지속적으로 가동됨과동시에 SSH셰션이 유지돼야했지만 residential proxy도입으로 해당 문제점들 해결
- **SSH 연결 실패 시 전체 우회 불가 극복**
    - residential proxy가 직접 HTTP/HTTPS 요청을 진행하므로 구현이 간단하고 유지보수가 쉬워짐

### 4. 결과: 성공 ⭕

- `curl -x` 테스트 시 `HTTP/1.1 200 OK` 반환
- YouTube API 응답 수신됨 (IP 변경 확인됨)

---

## 작성자: 김세찬 (DevOps 담당)

## 작성일: 2025-06-07